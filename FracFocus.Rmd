---
title: "Final Project"
author: "Shaun Donmoyer"
date: "10/23/2019"
output: html_document
---

# Load appropriate library

```{r}
library(odbc)
```

#Connect to database
```{r}
con <- dbConnect(odbc(),Driver="SQL Server",Server="localhost\\SQLEXPRESS", Database="FracFocusRegistry", Trusted_Connection="True") 
```

#Retreives all disclosures from Regisitry Upload Purpose
```{r}
RUP <- data.table(dbGetQuery(con, "SELECT * FROM [FracFocusRegistry].[dbo].[RegistryUploadPurpose]"))
```


# All Disclosures that include Acetic Acid
```{r}
Acetic <- data.table(dbGetQuery(con, "SELECT * FROM RegistryUploadIngredients Where IngredientName = 'Acetic Acid';"))
```

# All Disclosures that include Ammonium Persulfate
```{r}
AMPSF <- data.table(dbGetQuery(con, "SELECT * FROM RegistryUploadIngredients Where IngredientName = 'Ammonium Persulfate';"))
```

# All Breakers
```{r}
Breaker <- data.table(dbGetQuery(con, "SELECT * FROM RegistryUploadPurpose WHERE Purpose = 'Breaker';"))
```

# Breaker Trade Name and Frequency
```{r}
library(plyr)
Br_Freq <- count(Breaker, TradeName)
```

```{r}
top10_Br <- Br_Freq[c(610,578,315,469,374,313,561,452,222,318),]
```

```{r}
Br_plot <- qplot(TradeName, freq, data=top10_Br, main="Top 10 most used Breakers in FracFocus", xlab="TradeName", ylab="Frequency")
```

```{r}
Br_Plot <- ggplot(top10_Br, aes(x=TradeName, y=freq)) + geom_bar(stat="identity", color="blue",fill="white") + 
     labs(x="TradeName", y="Frequency",title="10 Most Used Breakers in FracFocus")+geom_text(aes(label=freq), vjust=1.6, color="black", size=3.5)+theme(axis.text.x=element_text(size=10,angle=45,hjust=1,vjust=1))

Br_Plot
```


```{r}
br_report <- function(TradeName){
  new_data <- Breaker[Breaker$TradeName %in% "TradeName", ]
    return(new_data)
}
```  
  
```{r}
for(Breaker in Breaker){
  print()
}
```


# Biocide
```{r}
Bio <- data.table(dbGetQuery(con, "SELECT * FROM RegistryUploadPurpose WHERE Purpose = 'Biocide';"))
```

```{r}
Bio_Freq <- count(Bio, "TradeName")
```

# Function for any Ingredient Purpose

```{r}
library(sqldf)
library(dplyr)
```

```{r}
Purpose_report <- function(Purpose){
  Purpose <- sqldf('select Purpose, TradeName from RUP where Purpose = "Breaker"')
  Freq_Purpose <- count(Purpose, TradeName)
  return(Freq_Purpose)
}

  
```


```{r}
report <- function(Purpose){
  
   if (!is.character(Purpose)) {
    stop("Purpose must be a character vector.")
   }
  
  Purpose <- sqldf('select Purpose, TradeName from RUP where Purpose = "Biocide"')
  new_data <- Purpose %>% 
    count(TradeName, sort=TRUE)
   new_data <- new_data[c(1:10), ]


  
   Br_Plot <- ggplot(new_data, aes(x=TradeName, y=n)) + geom_bar(stat="identity", color="blue",fill="white") + 
     labs(x="TradeName", y="Frequency",title="10 Most Used Biocide in FracFocus")+geom_text(aes(label=n), vjust=1.6, color="black", size=3.5)+theme(axis.text.x=element_text(size=10,angle=45,hjust=1,vjust=1))

Br_Plot
}
```


## This is the funtion for any ingredient purpose and plot its freq as bar plot.

```{r}
test <- function(purpose){
  
  if (!is.character(purpose)) {
    stop("Purpose must be a character vector.")
   }
  
  
  data <- RUP[which(RUP$Purpose == purpose), "TradeName" ]
  count_data <- data %>% 
    count(TradeName, sort = TRUE)
  count_data <- count_data[c(1:10), ]
    
  plot_title <- paste("10 most used", purpose, "in FracFocus")
    New_Plot <- ggplot(count_data, aes(x=TradeName, y=n)) + geom_bar(stat="identity", color="blue",fill="white") + 
     labs(x="TradeName", y="Frequency",title=plot_title) +geom_text(aes(label=n), vjust=1.6, color="black", size=3.5)+theme(axis.text.x=element_text(size=10,angle=45,hjust=1,vjust=1))

New_Plot
}
```



# Lat/Long for all wells in PA

```{r}
library("ggplot2")
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("rgeos")
library("ggspatial")
library("maps")
library("lwgeom")
library("mapsdata")
library("ggmap")
```

```{r}
pa_wells <- data.table(dbGetQuery(con, "SELECT [Latitude],[Longitude] FROM [FracFocusRegistry].[dbo].[RegistryUpload] Where StateNumber = '37';"))
```

```{r}
counties <- map_data("county")
pa_county <- subset(counties, region == "pennsylvania")

pa_base <- ggplot(data = pa_county, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")
pa_base + theme_nothing()+ 
  geom_polygon(data = pa_county, fill = NA, color = "white") +
  geom_polygon(color = "blue", fill = NA)

```


## Function to summarize any ingredient

```{r}
library(dplyr)
library(kableExtra)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
RUI <- data.table(dbGetQuery(con, "SELECT [IngredientName],[PercentHFJob] FROM [FracFocusRegistry].[dbo].[RegistryUploadIngredients]"))
```



```{r}
ing_report <- function(ingredient){
  
  
ing_name <- paste(ingredient)


  ing_summary <- RUI %>%
  
  filter(IngredientName == ing_name) %>%
  
  summarize(MeanWtPercent = mean(PercentHFJob, na.rm = TRUE), Minimum = min(PercentHFJob, na.rm=TRUE), Maximum = max(PercentHFJob, na.rm = TRUE), Count = n(), Quan10 = quantile(PercentHFJob, .1, na.rm = TRUE), Quan30 = quantile(PercentHFJob, .3, na.rm =TRUE), Quan50 = quantile(PercentHFJob, .5, na.rm = TRUE), Quan80 = quantile(PercentHFJob, .8, na.rm = TRUE))

names(ing_summary)[names(ing_summary) == "MeanWtPercent"] <- "Mean Wt %"
names(ing_summary)[names(ing_summary) == "Quan10"] <- "10th Percentile"
names(ing_summary)[names(ing_summary) == "Quan30"] <- "30th Percentile"
names(ing_summary)[names(ing_summary) == "Quan50"] <- "50th Percentile"
names(ing_summary)[names(ing_summary) == "Quan80"] <- "80th Percentile"

table_title <- paste("Ingredient Summary Report for", ing_name)

new_table <- ing_summary %>%
  kable(digits = 6, caption = table_title, booktabs = TRUE) %>%
  kable_styling()

return(new_table)
  
}

```


